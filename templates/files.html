<!DOCTYPE html>
<html>
<head>
    <title>GraPAT</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta name="description" content="An annotation tool for NLP problems which require graph representations.">
    <!--    <link rel="stylesheet" href="/static/css/graph.css">-->
    <link rel="stylesheet" href="/static/css/article.css">
    <script src="/static/js/jquery-3.7.1.js"></script>
    <link rel="stylesheet" href="/static/css/jquery-ui.css">
    <script src="/static/js/jquery-ui.js"></script>
    <!--    <script type='text/javascript' src='/static/js/jquery.ui.touch-punch.min.js'></script>-->
    <!--    <script type='text/javascript' src='/static/js/jquery.jsPlumb-1.5.1-min.js'></script>-->
    <script src="/static/js/sentiment_annotation.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/static/css/bootstrap-3.2.0.min.css">
    <script src="/static/js/bootstrap-3.2.0.min.js"></script>
    <script src="/static/js/bootbox-4.2.0.min.js"></script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <h1>GraPAT (Graph-based Potsdam Annotation Tool)</h1>
    </div>
    <div id="navbar" class="row">
        <a type="button" class="btn btn-success" href="/">
            Annotator
        </a>
        <a type="button" class="btn btn-success" href="/files">
            Settings
        </a>
    </div>
    <div class="row">
        <form class="form-inline">
            <label for="username">Annotator:</label>
            <select id="username" name="annot_file_select" class="form-control" readonly>
            </select>
            <label for="filesList">Annotation File:</label>
            <select id="filesList" name="filesList" class="form-control"
                    onchange="change_annot_file();">
                <option value="" disabled="disabled" selected="selected">Please select a file for annotation</option>
            </select>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalFiles">
                Add Files
            </button>
            <button type="button" class="btn btn-primary"
                    onclick="exportDB();">
                Export Annotations
            </button>
        </form>
    </div>
    <div class="row" style="padding: 10px">
        <div class="col-lg-6" style="border: 1px solid #ccc">
            <form>
                <div class="form-group form-inline">
                    <span id="textId"></span>
                </div>
                <textarea id="fileText" class="form-control" rows="25"></textarea>
                <div class="form-group form-inline">
                    <button type="button" class="btn btn-danger" onclick="revertText()">Revert</button>
                    <button type="button" class="btn btn-danger" onclick="deleteFile()">Delete</button>
                    <button type="button" class="btn btn-primary" onclick="getEDUsegmentedText()">Segmentation</button>
                    <button type="button" class="btn btn-success" onclick="saveTextToDB()">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal Files -->
    <div class="modal fade" id="modalFiles" tabindex="-1" role="dialog" aria-labelledby="modalFilesLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="modalFilesLabel">File Upload</h4>
                </div>
                <div class="modal-body">
                    <form id="formFiles" enctype="multipart/form-data" method="post">
                        <input id="iptFiles" name="file" type="file" multiple/>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="addFiles()">Add Files
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script type='text/javascript'>

    let originalText = "";

    function get_files_to_be_annotated() {
        $.getJSON("/resources", function (data) {
            const flist = $('#filesList');
            flist.empty();
            flist.append($('<option>', {value: -1, text: 'Select file...'}));
            $.each(data, function (key, value) {
                flist.append($('<option>', {value: key}).text(value));
            });
        });
    }

    function revertText() {
        $('#fileText').val(originalText);
    }

    function saveTextToDB() {
        const segments = $('#fileText').val().split('\n');
        const flist = $('#filesList')[0];
        const fname = flist.options[flist.selectedIndex].text;
        $.ajax({
            url: "/grapat/file",
            type: 'PUT',
            data: {
                textId: fname,
                segments: JSON.stringify(segments),
            },
            success: function (result) {
                // Do something with the result
                console.log(result);
            }
        });
    }

    function change_annot_file() {
        const flist = $("#filesList")[0];
        const fname = flist.options[flist.selectedIndex].text;

        if (flist.selectedIndex === 0) return

        jQuery.get("/resources/" + fname, function (data) {
            var resultSentences = [];
            var all_sentences = $(data).find('entity');
            jQuery.each(all_sentences, function () {
                var current_sentence = $(this);
                $('#textId').text("ID: " + current_sentence.attr('id'));
                var words = current_sentence.find('token_range');
                jQuery.each(words, function () {
                    // var t_id = $(this).attr('id');
                    resultSentences.push($(this).text());
                });
            });
            console.log(resultSentences)
            // $('#fileText').text(resultSentences.join('\n'));
            originalText = resultSentences.join('\n');
            $('#fileText').val(originalText);
        });
    }

    function getEDUsegmentedText() {
        $.post("/edu/segment", {
            "text": $('#fileText').val(),
        }, function (data) {
            console.log(data);
            $('#fileText').val(data['text']);
        });
    }

    function addFiles() {
        var fd = new FormData();
        $.each($('#iptFiles')[0].files, function (i, file) {
            fd.append('files', file);
        });
        console.log(fd);
        $.ajax({
            url: "/grapat/file",
            type: "POST",
            data: fd,
            contentType: false,
            processData: false,
            cache: false,
            success: function (response) {
                if (response !== 0) {
                    document.getElementById("formFiles").reset();
                    get_files_to_be_annotated();
                    change_annot_file();
                } else {
                    alert('file not uploaded');
                }
            },
        })
    }

    function deleteFile() {
        const flist = $('#filesList')[0];
        const fname = flist.options[flist.selectedIndex].text;
        $.ajax({
            url: "/grapat/file",
            type: 'DELETE',
            data: {
                textId: fname,
            },
            success: function (result) {
                // Do something with the result
                console.log(result);
                $('#fileText').val("");
                document.location.reload();
            }
        });
    }

    function exportDB() {
        let username = $("#username").val()
        $.post('/grapat/export', {
            "annotator": JSON.stringify(username),
        }, function (data) {
            $("#exported").hide().fadeIn(1500);
            $("#exported").fadeOut(2500);
        });
    }

    function getUsers() {
        $.getJSON("/users", function (data) {
            console.log(data);
            $('#username').empty();
            data.forEach(function (v) {
                $('#username')
                    .append($('<option>', {value: v.username})
                        .text(v.username));
            });
        });
    }

    window.onload = function () {
        get_files_to_be_annotated();
        getUsers();
    }

</script>
</body>

</html>